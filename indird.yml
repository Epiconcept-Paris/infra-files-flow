---

# extract real indird.yml confs using
#
# yaml2json indird.yml | jq .hosts.procom1.confs > indird.json # -> procom1:/etc/indird.conf
# yaml2json indird.yml | jq .hosts.profnt2.confs > indird.json # -> profnt2:/etc/indird.conf

hosts:
  procom1:
    confs:
      # real indird.yml for procom1 starts here
      # each 'confs' member has it's own indird@.service instance
      sspdamoc:

        # required spool dir
        path: /home/sspdamoc/inbox

        # required poll delay
        sleep: 60

        # optional sanity check
        host: procom1

        # optional prefix for environment variables
        # defaults to INDIRD_
        env_prefix: i_

        # optional dict of environment variables for action commands
        # environment variables set by daemon itself are in upper case:
        #   ${env_prefix}PATH
        #   ${env_prefix}FILE
        #   ${env_prefix}STATUS
        env:
          donedir: /home/sspdamoc/done
          faildir: /home/sspdamoc/fail
          front: profnt2.front2
          user: sspdamoc

        # required dict of filename patterns to watch for in spool dir
        filenames: &filenames
          hl7:
            # required desc for use in daemon error messages
            desc: hl7 files
            type: fileglob
            pattern: '[a-z]*.hl7'
          # example of possible extension
          pdf:
            desc: pdf files
            type: regexp
            pattern: '.*\.pdf$'

        # dict of cmds to implement actions
        # error managed via return field
        # required
        actions:
          copy:
            desc: copy file to remote node
            cmd: |
              rsync -e "ssh -i $i_PATH/.ssh/rsync -l $i_user" "$i_FILE" $i_front:

        # dict of commands triggered by actions exit status
        # error managed by daemon itself
        # similar to actions but must not appear in action field of rules
        # required if referenced by rules
        returns: &returns
          done:
            desc: move file to archive dir
            cmd: mv "$i_FILE" $i_donedir
            # actions and returns may ask chdir (default to spool dir)
            chdir:
            # actions and returns may change environment
            env:
              TMP: /space/tmp
          fail:
            desc: move file to fail dir
            cmd: mv "$i_FILE" $i_faildir
          mail:
            desc: send mail
            cmd: mail -s "$i_FILE $i_STATUS" infosadminrobots@epiconcept.fr c.girard@epiconcept.fr
            # returns may use combined stdin and stdout of actions
            stdin: output # either stdout, stderr or output for combined stdout and stderr

        # timeout may wrap actions
        # required if referenced by rules
        timeouts: &timeouts
          default:
            wait: 30
            retry: 4

        # log may wrap actions
        # required if referenced by rules
        logs: &logs
          debug:
            desc: log to file
            type: file
            args:
              path: /var/log/indird.log
          default:
            desc: log to syslog
            type: syslog
            args:
              level: LOG_ERR
              facility: USER

        # yaml kludge, recognized but discarded by daemon
        macros:
          - &hl7
            # generic hl7 copy rule
            filename: hl7       # a pattern from filenames dict
            action: copy        # an action from actions dict
            timeout: default    # a timeout from timeouts dict
            on_return:
              ok: [ ok ]                 # a list of cmds from returns dict if exit status OK
              ko: [ fail, mail ]         # a list of cmds from returns dict if exit status !OK
            log_to: [ debug, default ]   # a list of logs from logs dict

        # list of actions to trigger on spool dir files
        # binds filename, action, timeout or retry, on_return, log_to
        rules:
          - desc: sspdamoc instance
            <<: *hl7

        # config for sspdamoc instance on procom1 ends here

      sspnice:
        path: /space/home/sspnice/hl7
        sleep: 60

        env_prefix: i_
        env:
          home: /space/home/sspnice
          donedir:  /space/home/sspnice/done
          faildir: /space/home/sspnice/fail
          front: profnt2.front2
          user: sspnice

        filenames: *filenames
        returns: *returns
        logs: *logs

        actions:
          copy:
            desc: copy file to front
            cmd: rsync -e "ssh -i $i_home/.ssh/rsync -l $i_user" "$i_FILE" --whole-file --partial-dir ../tmp $i_front:hl7

        rules:
          - desc: sspnice instance
            <<: *hl7

      rdvradio:
        path: /space/home/rdvradio/HL7_spl
        sleep: 60
        env_prefix: i_
        env:
          home: /space/home/rdvradio
          front: profntd1.front2
          user: esis-data-pro
          remotedir: hl7/centre/in/cim-2745-CIM_Creteil_Soleil
        filenames:
          hl7:
            desc: hl7 files
            type: fileglob
            pattern: 'CCR_*'
        actions:
          copy:
            desc: copy file to front
            cmd: rsync -a -e "ssh -i $i_home/.ssh/rsync -l $i_user" "$i_FILE" --whole-file --partial-dir ../tmp $i_front:$i_remotedir
        returns:
          done:
            desc: move file to archive dir
            cmd: mv "$i_FILE" $i_home/HL7_done
          fail:
            desc: move file to fail dir
            cmd: mv "$i_FILE" $i_home/HL7_fail

        # real indird.yml on procom1 ends here

  profntd1:
    confs:
      rdvradio:
        path: /space/applistmp/budi/neoesis_prod/hl7/centre/in/cim-2745-CIM_Creteil_Soleil
        sleep: 60
        env_prefix: i_
        env:
          basedir: /space/applistmp/budi/neoesis_prod/hl7/centre
          name: cim-2745-CIM_Creteil_Soleil
        filenames:
          hl7:
            desc: hl7 files
            type: fileglob
            pattern: 'CCR_*'
        actions:
          copy:
            desc: run task
            cmd: sudo -u www-data /usr/local/bin/runTask production $i_basedir/in/$i_name/"$i_FILE" simulation
        returns:
          done:
            desc: move file to archive dir
            cmd: mv "$i_FILE" $i_basedir/done/$i_name
          fail:
            desc: move file to fail dir
            cmd: mv "$i_FILE" $i_basedir/fail/$i_name

  profnt2:
    confs:
      sspnice:

        path: /space/applistmp/sspnice/hl7
        sleep: 60

        env_prefix: i_
        env:
          script: /space/www/apps/ssp/ressources/hl7/import.php

        filenames: *filenames
        returns: *returns
        logs: *logs

        actions:
          check:
            desc: check before run
            cmd: file "$i_FILE" | grep ASCII
          run:
            desc: call php script
            cmd: sudo -u www-data /usr/bin/php $i_script "$i_FILE"

        retries:
          default:
            count: 3
            delay: 120
            timeout: 30

        rules:
          - desc: check_sspdamoc
            filename: hl7
            action: check
            on_return:
              ko: [ fail, mail ]
            log_to: [ debug, default ]
          - desc: run_sspdamoc
            filename: hl7
            action: run
            retry: default
            on_return:
              ok: [ ok ]
              ko: [ fail, mail ]
            log_to: [ debug, default ]
