#!/bin/bash
#
#	mkiconf - Output host's indird.conf from a global YAML file
#
Prg=`basename $0`

# check args
test "$2" || { echo "Usage: $Prg <yaml-file> <host>" >&2; exit 1; }
yaml=$1
host=$2

# check if $yaml exists
test -f "$yaml" || { echo "$Prg: cannot find YAML file \"$yaml\"" >&2; exit 2; }

# check if $yaml is valid YAML
conf=$(yaml2json "$yaml") || exit 3

# check if $yaml has hosts
keys=$(<<<"$conf" jq -e -r '.hosts|keys[]' 2>/dev/null) || { echo "$Prg: no '.hosts' key in $yaml" >&2; exit 4; }

# check if $host is host in $yaml
echo "$keys" | grep -q "^$host\$" || { echo "$Prg: unknown host $host in $yaml" >&2; echo "Available hosts:" >&2; echo "$keys" | sed 's/^/    /' >&2; exit 5; }

# all ok, output our config
<<<"$conf" jq --indent 4 ".hosts.$host.confs" | unexpand --first-only | sed "1i\\
#\\
#	indird.conf for $host\\
#	generated from $yaml\\
#"
