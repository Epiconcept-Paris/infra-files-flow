#!/bin/bash
#todo extraire les dossiers fail et montrer les fichiers qui s'y trouvent (et doivent être re-traités)
#todo surveillance des logs, à définir

Cfg='/etc/indird.conf'
Dir='/etc/indird.d'
Cnf='config.json'
tty >/dev/null && { Bold=$(tput bold); Norm=$(tput sgr0); }

Bold() { echo "$Bold$1$Norm"; }

Split=$(echo $Dir/*/$Cnf)	# Gather 'Split' (per stream) config files
[[ "$Split" = "$Dir/*/$Cnf" ]] && Split=

# Split instances have precedence over the same in $Cfg (through jq's 'add')
list=$(cat $Cfg $Split | jq -sr 'add|keys_unsorted|join("\n")')
[[ "$Dbg" ]] && { echo "$list"; exit 0; }

[[ "$1" = 'split' ]] && {
    Su='sudo'
    [[ "$INDIRD_NLOCAL" ]] && Su="$Su --preserve-env=INDIRD_NLOCAL"
}
[[ "$1" = 'cache' ]] && {
    case "$2" in
	gen) Su='sudo'; [[ "$INDIRD_NLOCAL" ]] && Su="$Su --preserve-env=INDIRD_NLOCAL" ;;
	del) Su='sudo' ;;
    esac
}

case $1 in
    status)	for i in $list; do systemctl status "indird@$i"; done ;;
    start|stop|restart|reload)
		for i in $list; do Bold "$i"; sudo systemctl "$1" "indird@$i"; done ;;
    resetlog)	for i in $list; do Bold "$i"; sudo systemctl kill --signal=HUP "indird@$i"; done ;;
    split)	for i in $list; do test -f "$Dir/$i/$Cnf" || $Su indird "$i" split; done ;;
    cache)	for i in $list; do $Su indird "$i" cache "$2"; done ;;
    ps)		systemctl | grep 'indird@' ;;
    ls)		[[ "$list" && "$list" != 'null' ]] && echo "$list" ;;
    paths)
	cat $Cfg $Split | jq -sr 'add|keys_unsorted[] as $k | "\($k)|\(.[$k] | .path)"' | column -s '|' -t | sed 's;/$;;'
	;;
    check)
	if [[ "$list" && "$list" != 'null' ]]; then
	    for srvtype in indird indirdwake; do
		services=$(systemctl list-units --all | grep -v masked | grep $srvtype@)
		for i in $list; do
		    result=$(echo "$services" | grep "$srvtype@$i.service")
		    test "$result" || echo "$srvtype@$i.service (absent)"
		    if [[ "$result" =~ "failed" ]]; then
			echo "$srvtype@$i.service (failed) $result"
		    elif [[ "$result" =~ "dead" && $srvtype == "indird" ]]; then
			echo "$srvtype@$i.service (dead)"
		    fi
		done
		IFS=$'\n'
		for i in $services; do
		    service=$(echo $i | sed 's/^..//' | awk '{print $1}' | sed -E -e 's/.*@//' -e 's/\.[a-z]+$//')
		    result=$(echo "$list" | grep "$service")
		    test "$result" || echo "$service (non déclaré)"
		done
	    done | sort -u
	fi
	;;
    debug)
	for instance in $list; do
	    cfg=$(cat $Cfg $Split | jq -s "add|.$instance")
	    cmd=$(jq -r '.actions.copy.cmd' <<<"$cfg" | sed 's/"\$i_FILE"/$FILE/g')
	    vars=$(jq -r '.env|keys_unsorted|join(" ")' <<<"$cfg")
	    Bold "$instance"; echo -e " - cmd: $cmd\n - vars: $vars"
	    for var in $vars; do
		value=$(jq -r ".env.$var" <<<"$cfg")
		cmd=$(echo "$cmd" | sed -e "s#\$i_${var}#$value#g")
	    done
	    echo " - cmd calculée: $cmd"
	done
	;;
    *)
	echo "Usage: $0 status|ps|check|debug|paths|start|stop|restart|reload|resetlog"
esac
